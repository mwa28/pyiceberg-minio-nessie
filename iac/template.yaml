
AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: IoT File Processing with DuckDB and PyIceberg

Resources:
  IoTFileProcessor:
    Type: AWS::Serverless::Function
    # Metadata:
    #     Dockerfile: Dockerfile  
    #     DockerContext: ./lambda  
    #     DockerTag: latest  
    Properties:
      PackageType: Image  
      Architectures:
        - arm64  
      ImageUri: iot-file-processor:latest  
      Environment:
        Variables:
          MINIO_ENDPOINT: !Ref MinioEndpoint
          MINIO_ACCESS_KEY: !Ref MinioAccessKey
          MINIO_SECRET_KEY: !Ref MinioSecretKey
          NESSIE_ENDPOINT: !Ref NessieEndpoint
      Events:
        IoTFileEvent:
          Type: S3
          Properties:
            Bucket: iot-bucket 
            Events: s3:ObjectCreated:*

Parameters:
  MinioEndpoint:
    Type: String
    Default: "http://localhost:9000"
  MinioAccessKey:
    Type: String
    Default: "minioadmin"
  MinioSecretKey:
    Type: String
    Default: "minioadmin"
  NessieEndpoint:
    Type: String
    Default: "http://localhost:19120/iceberg"
